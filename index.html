<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create gifts</title>
</head>
<body>
  <div id="message">Please select an image to remove the background.</div>
  <input type="file" id="imageInput" accept="image/*" style="display:none;">
  <button id="triggerFileInput">Select Image</button>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      gap: 25px;
      font-family: sans-serif;
    }

    #message {
      font-size: 22px;

    }

    #triggerFileInput  {
      padding: 20px;
      font-size: 18px;
      cursor: pointer;
      background-color: black;
      color: white;
    }
  </style>
  <script>
    const url = 'https://sdk.photoroom.com/v1/segment';
    const apiKey = "sandbox_a16ad797899904af12e7a96128700cfa1535f3f0"; // Replace with your actual PhotoRoom API key
    const imgurClientId = "224b027ad19158d"; // Replace with your actual Imgur Client ID
    const imgurClientSecret = "d06e58b96122410828a5faf36672494509bd138f"; // Replace with your actual Imgur Client Secret

    // Function to get the access token from Imgur
    async function getImgurAccessToken() {
        const auth = btoa(`${imgurClientId}:${imgurClientSecret}`); // Base64 encode Client ID and Client Secret

        const response = await fetch('https://api.imgur.com/oauth2/token', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${auth}`,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                grant_type: 'client_credentials'
            })
        });

        const data = await response.json();
        return data.access_token;
    }

    // Function to upload the image blob to Imgur
    async function uploadImageToImgur(imageBlob) {
        const accessToken = await getImgurAccessToken(); // Get the access token
        const formData = new FormData();
        formData.append('image', imageBlob); // Add the image blob to the form

        const response = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`
            },
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            console.log('Image uploaded successfully!', data.data.link);
            return data.data.link; // The URL of the uploaded image
        } else {
            console.error('Image upload failed', data);
            throw new Error('Imgur upload failed');
        }
    }

    // Function to remove the background from the image using PhotoRoom API
    async function removeBackground(imageFile) {
        const formData = new FormData();
        formData.append('image_file', imageFile);

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-Api-Key': apiKey
            },
            body: formData
        });

        if (!response.ok) {
            console.error(await response.json());
            throw new Error('PhotoRoom API request failed');
        }

        const imageBlob = await response.blob();
        const uploadedImageUrl = await uploadImageToImgur(imageBlob); // Upload the image to Imgur and get the URL
        return { imageUrl: uploadedImageUrl, mime: imageBlob.type };
    }

    document.addEventListener('DOMContentLoaded', () => {
        const imageInput = document.getElementById('imageInput');
        const triggerButton = document.getElementById('triggerFileInput');

        // Show message or button after page loads
        document.getElementById('message').style.display = 'block';

        // Button click triggers the file input
        triggerButton.addEventListener('click', () => {
            imageInput.click(); // Trigger file input click event
        });

        // Listen for the file input change event
        imageInput.addEventListener('change', async (event) => {
            const imageFile = event.target.files[0];

            if (imageFile) {
                try {
                    // Remove the background using the PhotoRoom API
                    const { imageUrl, mime } = await removeBackground(imageFile);

                    // Send the image URL and MIME type to the parent iframe
                    window.parent.postMessage({
                        message_type: 'IMAGE_SELECTED',
                        url: imageUrl,
                        mime: mime
                    }, '*');
                } catch (error) {
                    console.error('Error removing background:', error);
                }
            }
        });
    });

  </script>
</body>
</html>